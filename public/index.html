<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krosspost - Instagram Claims</title>
  <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@12.0.0/build/esm/styles.css">
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    #app {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
      color: #202223;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #202223;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #c9cccf;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #008060;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    button:hover {
      background: #006e52;
    }
    .claims-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .claims-table th {
      background: #f6f6f7;
      padding: 12px;
      text-align: left;
      font-weight: 500;
      border-bottom: 1px solid #e1e3e5;
    }
    .claims-table td {
      padding: 12px;
      border-bottom: 1px solid #e1e3e5;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-new { background: #e3f2fd; color: #1976d2; }
    .status-matched { background: #fff3e0; color: #f57c00; }
    .status-reserved { background: #e8f5e9; color: #388e3c; }
    .status-link_sent { background: #e1f5fe; color: #0288d1; }
    .status-paid { background: #c8e6c9; color: #2e7d32; }
    .status-expired { background: #ffebee; color: #c62828; }
    .status-failed_parse { background: #fce4ec; color: #c2185b; }
    .status-out_of_stock { background: #fff9c4; color: #f57f17; }
  </style>
</head>
<body>
  <div id="app">
    <h1>üéØ Krosspost - Instagram Claims to Shopify</h1>
    
    <div class="section">
      <h2>üì± Instagram Connection</h2>
      <p style="color: #666; margin-bottom: 15px;">
        Connect your Instagram Business account to start receiving claims from comments and DMs.
      </p>
      <button id="connectIgBtn" style="background: #E4405F; display: flex; align-items: center; gap: 10px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
          <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
        </svg>
        Connect Instagram Account
      </button>
      <p id="igConnectionStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
    </div>

    <div class="section">
      <h2>üé™ Campaigns</h2>
      <button onclick="loadCampaigns()" style="margin-bottom: 15px;">Refresh Campaigns</button>
      <table class="claims-table" id="campaignsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Hold Time</th>
            <th>Per Person Limit</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="campaignsBody">
          <tr><td colspan="6" style="text-align: center; color: #999;">No campaigns yet. Create one below.</td></tr>
        </tbody>
      </table>
      
      <h3 style="margin-top: 30px;">Create New Campaign</h3>
      <div class="form-group">
        <label>Campaign Name</label>
        <input type="text" id="campaignName" placeholder="e.g., Summer Drop 2025">
      </div>
      <div class="form-group">
        <label>Hold Time (minutes)</label>
        <input type="number" id="holdTime" value="15" min="5" max="120">
      </div>
      <div class="form-group">
        <label>Per Person Limit (optional)</label>
        <input type="number" id="perPersonLimit" placeholder="Leave empty for no limit">
      </div>
      <button onclick="createCampaign()">Create Campaign</button>
    </div>

    <div class="section">
      <h2>üó∫Ô∏è Mapping Rules</h2>
      <div class="form-group">
        <label>Select Campaign</label>
        <select id="selectedCampaignId" onchange="loadMappingRules()">
          <option value="">-- Select a campaign --</option>
        </select>
      </div>
      <button onclick="loadMappingRules()" style="margin-bottom: 15px;">Refresh Rules</button>
      <table class="claims-table" id="rulesTable">
        <thead>
          <tr>
            <th>Strategy</th>
            <th>Trigger Pattern</th>
            <th>SKU</th>
            <th>Variant ID</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rulesBody">
          <tr><td colspan="5" style="text-align: center; color: #999;">Select a campaign to view rules</td></tr>
        </tbody>
      </table>
      
      <h3 style="margin-top: 30px;">Add New Mapping Rule</h3>
      <div class="form-group">
        <label>Strategy</label>
        <select id="mappingStrategy">
          <option value="sequential_id">Sequential ID (#1, #2, #3...)</option>
          <option value="sku">SKU</option>
          <option value="keyword">Keyword</option>
        </select>
      </div>
      <div class="form-group">
        <label>Trigger Pattern</label>
        <input type="text" id="triggerPattern" placeholder="e.g., 1 or sku123 or drop1">
      </div>
      <div class="form-group">
        <label>Shopify Variant ID</label>
        <input type="text" id="variantId" placeholder="Enter variant ID from Shopify">
      </div>
      <button onclick="addMappingRule()">Add Mapping Rule</button>
    </div>

    <div class="section">
      <h2>üìã Claims Board</h2>
      <button onclick="loadClaims()">Refresh Claims</button>
      <table class="claims-table" id="claimsTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Status</th>
            <th>Channel</th>
            <th>User</th>
            <th>Message</th>
            <th>Variant</th>
            <th>Checkout URL</th>
          </tr>
        </thead>
        <tbody id="claimsBody">
          <tr><td colspan="7" style="text-align: center; color: #999;">No claims yet. Click Refresh to load.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const shopDomain = new URLSearchParams(window.location.search).get('shop');
    const igConnected = new URLSearchParams(window.location.search).get('instagram_connected');
    
    if (igConnected === 'true') {
      document.getElementById('igConnectionStatus').innerHTML = '‚úÖ <strong>Instagram connected successfully!</strong>';
      document.getElementById('igConnectionStatus').style.color = '#2e7d32';
    }
    
    document.getElementById('connectIgBtn')?.addEventListener('click', function() {
      if (!shopDomain) {
        alert('Shop parameter missing');
        return;
      }
      window.location.href = `/auth/instagram?shop=${shopDomain}`;
    });
    
    async function loadCampaigns() {
      try {
        const response = await fetch(`/api/campaigns?shop=${shopDomain}`);
        const data = await response.json();
        
        const tbody = document.getElementById('campaignsBody');
        const select = document.getElementById('selectedCampaignId');
        
        if (data.campaigns.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No campaigns found</td></tr>';
          return;
        }
        
        // Update campaigns table
        tbody.innerHTML = data.campaigns.map(c => `
          <tr>
            <td><strong>${c.name}</strong><br><small style="color: #999;">${c.id}</small></td>
            <td>${c.hold_time_minutes} min</td>
            <td>${c.per_person_limit || 'Unlimited'}</td>
            <td><span class="status-badge" style="background: ${c.is_active ? '#e8f5e9' : '#ffebee'}; color: ${c.is_active ? '#388e3c' : '#c62828'};">${c.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>${new Date(c.created_at).toLocaleDateString()}</td>
            <td>
              <button onclick="selectCampaign('${c.id}')" style="padding: 5px 10px; font-size: 12px;">Select</button>
              <button onclick="deleteCampaign('${c.id}')" style="padding: 5px 10px; font-size: 12px; background: #c62828;">Delete</button>
            </td>
          </tr>
        `).join('');
        
        // Update campaign dropdown
        select.innerHTML = '<option value="">-- Select a campaign --</option>' + 
          data.campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      } catch (error) {
        alert('Error loading campaigns: ' + error.message);
      }
    }
    
    function selectCampaign(campaignId) {
      document.getElementById('selectedCampaignId').value = campaignId;
      loadMappingRules();
    }
    
    async function deleteCampaign(campaignId) {
      if (!confirm('Are you sure you want to delete this campaign? This will also delete all associated mapping rules.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Campaign deleted successfully');
          loadCampaigns();
        } else {
          alert('Failed to delete campaign');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
    
    async function createCampaign() {
      const name = document.getElementById('campaignName').value;
      const holdTimeMinutes = parseInt(document.getElementById('holdTime').value);
      const perPersonLimit = document.getElementById('perPersonLimit').value;
      
      if (!name) {
        alert('Please enter a campaign name');
        return;
      }
      
      try {
        const response = await fetch('/api/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shop: shopDomain,
            name,
            holdTimeMinutes,
            perPersonLimit: perPersonLimit ? parseInt(perPersonLimit) : null
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('Campaign created! ID: ' + data.campaign.id);
          document.getElementById('campaignName').value = '';
          loadCampaigns();
        } else {
          alert('Failed to create campaign');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
    
    async function loadMappingRules() {
      const campaignId = document.getElementById('selectedCampaignId').value;
      const tbody = document.getElementById('rulesBody');
      
      if (!campaignId) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Select a campaign to view rules</td></tr>';
        return;
      }
      
      try {
        const response = await fetch(`/api/campaigns/${campaignId}/mapping-rules`);
        const data = await response.json();
        
        if (data.rules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No mapping rules found for this campaign</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.rules.map(r => `
          <tr>
            <td>${r.strategy}</td>
            <td>${r.trigger_pattern}</td>
            <td>${r.sku || '-'}</td>
            <td>${r.shopify_variant_id || '-'}</td>
            <td>
              <button onclick="deleteRule('${r.id}')" style="padding: 5px 10px; font-size: 12px; background: #c62828;">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        alert('Error loading mapping rules: ' + error.message);
      }
    }
    
    async function deleteRule(ruleId) {
      if (!confirm('Are you sure you want to delete this mapping rule?')) {
        return;
      }
      
      try {
        console.log('Deleting rule:', ruleId);
        const response = await fetch(`/api/mapping-rules/${ruleId}`, {
          method: 'DELETE'
        });
        
        console.log('Delete response:', response.status);
        const data = await response.json();
        console.log('Delete data:', data);
        
        if (response.ok) {
          alert('Mapping rule deleted successfully');
          loadMappingRules();
        } else {
          alert('Failed to delete mapping rule: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    async function addMappingRule() {
      const campaignId = document.getElementById('selectedCampaignId').value;
      const strategy = document.getElementById('mappingStrategy').value;
      const triggerPattern = document.getElementById('triggerPattern').value;
      const variantId = document.getElementById('variantId').value;
      
      if (!campaignId || !triggerPattern || !variantId) {
        alert('Please select a campaign and fill in all required fields');
        return;
      }
      
      try {
        const body = {
          campaignId,
          strategy,
          triggerPattern,
          shopifyVariantId: variantId
        };
        
        if (strategy === 'sequential_id') {
          body.sequentialId = parseInt(triggerPattern);
        } else if (strategy === 'sku') {
          body.sku = triggerPattern;
        }
        
        const response = await fetch('/api/mapping-rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (response.ok) {
          alert('Mapping rule added successfully!');
          document.getElementById('triggerPattern').value = '';
          document.getElementById('variantId').value = '';
          loadMappingRules();
        } else {
          alert('Failed to add mapping rule');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
    
    async function loadClaims() {
      try {
        const response = await fetch(`/api/claims?shop=${shopDomain}`);
        const data = await response.json();
        
        const tbody = document.getElementById('claimsBody');
        
        if (data.claims.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No claims found</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.claims.map(claim => `
          <tr>
            <td>${new Date(claim.created_at).toLocaleString()}</td>
            <td><span class="status-badge status-${claim.status}">${claim.status}</span></td>
            <td>${claim.channel}</td>
            <td>@${claim.ig_username || claim.ig_user_id}</td>
            <td>${claim.raw_message}</td>
            <td>${claim.matched_variant_id || '-'}</td>
            <td>${claim.checkout_url ? `<a href="${claim.checkout_url}" target="_blank">View</a>` : '-'}</td>
          </tr>
        `).join('');
      } catch (error) {
        alert('Error loading claims: ' + error.message);
      }
    }
    
    // Auto-load campaigns on page load
    if (shopDomain) {
      loadCampaigns();
    }
  </script>
</body>
</html>
